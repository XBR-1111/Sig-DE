# 修改意见汇总

1. 在结果里加一些评价指标，包括年化收益、波动率、夏普比率、最大回撤、IC(股票评分和下期收益的pearson相关系数)、Rank IC(股票评分和下期收益的Spearman相关系数)等。这些指标的计算，你可以参考一下https://arxiv.org/pdf/1908.02646.pdf。在计算累计收益的时候，用单利方式计算。在比较结果的时候，需要这几条收益曲线：根据这个算法构建的投资组合、和中证500指数对冲、和沪深300指数对冲、中证500指数、沪深300指数。这里对冲收益就是拿算法的收益减去指数的收益。
2. indicator的正负判断这比较难，而且不同时期可能表现不同，所以按原样输入就行。
3. 构建投资组合的时候，除了等权重外，还计算按市值加权的结果。
4. 在特征上，不局限于当前的特征，可以将之前时刻的特征也加入，也就是输入可以是时间序列。
5. 注意不要用到未来信息。我提供给你的月份d的因子数据，只能在d+1个月初构建投资组合时用。另外，因子数据里的return，指的是当月的return。
6. 你用IC作为优化目标，每期的IC就是截面上所有股票的评分和收益。哪怕股票只出现了一个月，应该也可以加入训练集。



# 修改方案

## 输入数据的改进

1. 在所选取的月份中，如果当月特征齐全，且拥有下一个月的ret，则将该股票放入该月的训练数据内。
2. 市值market cap将用作构建投资组合，所以应该能在数据处理时将market cap分离。
3. 输入特征可以是时间序列。在config中设置特征的长度。
4. 增加中证500指数，沪深300指数数据获取。

## 模型的改进

有关I 的维度都需要做出改变，由于股票数不再对齐，可将涉及的数据结构改为np.array的list。



# 7.5笔记

### 大幅提升模型对输入数据的适应性

1. 将模型中的数据结构进行改变，以适应不同时刻训练数据股票数量不同的情况

   * 由于$I$不再独立于$T$，因此原来同时涉及维度$I$和$T$的数据都变成时间列表的数据结构。

2. 数据处理输入输出改变。

   数据处理部分**原输入**为：

   * prices：候选股票价格数据，具有维度$(I,T+1)$
   * features：候选特征数据，具有维度$(I,D,T)$
   * indicators: 指示候选特征数值越大越好/越小越好，维度$D$
   * prices与features的关系：price代表时间片缝隙处的股票的价格，因此时间维度多1。

   **现输入**改为：

   * features：候选特征数据，长度为$T$的数组，元素具有维度$(I,D)$
   * indicators: 指示候选特征数值越大越好/越小越好，维度$D$
   * returns: 候选股票回报率数据，长度为$T$的数组，元素具有维度$(I)$，对应feature中的下一个时刻的回报率

   数据处理部分**原输出**为：

   * Y_data：经过Z-score归一化后的feature，具有维度$(I,D,T-1)$
   * returns：根据price数据计算的股票在时间片内的真实回报率，具有维度$(I,T-1)$
   * rank_data：根据returns数据计算的股票在时间片内的真实回报率排名，具有维度$(I,T-1)$
   * 注意此处returns的时间维度落后Y_data一个时间片，于是returns就成为Y_data对应的下一个时间片的测试数据，因此损失了最后一个时间片的Y_data和第一个时间片的returns和rank_data，因而是$T-1$。

   现输出改为：

   * Y_data：经过Z-score归一化后的feature，长度为$T$的数组，元素具有维度$(I,D)$
   * returns：候选股票回报率数据，长度为$T$的数组，元素具有维度$(I)$，对应feature中的下一个时刻的回报率
   * rank_data：根据returns数据计算的股票在时间片内的真实回报率排名，长度为$T$的数组，元素具有维度$(I)$
   * 注意此处returns的时间维度落后Y_data一个时间片，returns是Y_data对应的下一个时间片的测试数据。

### 支持同一个case跑多组数据

1. config增加参数times_per_case，用于支持同一个case跑多次取平均值，所得结果更加稳定。

### 数据处理修改

1. 取消由price.pkl计算股票的收益，转而用factor数据中的ret作为指标，构造输入数据。由于股票数据的完整性需要，每个时刻选取股票的数量不同，股票数量总体呈跟随时间上升的趋势。
2. 由于每个时间点选取的股票数量都不相同，因而需要记录每个时刻被选做训练集的股票，stock_names.pkl

### 其他小的修改

1. SigDE删除参数self.m：某一个case选出的股票数量并不需要为SigDE model所知，只需在测试时使用。
2. 完善实现文档，对SigDE的成员函数做出进一步说明。
3. 模型的输出改为只输出feat_params（特征选取与特征权重）

## 后续需要修改的内容

1. 支持时间序列特征的输入
2. 构建投资组合的时候，除了等权重外，还计算按市值加权的结果
3. 在结果里加一些评价指标，包括年化收益、波动率、夏普比率、最大回撤、IC(股票评分和下期收益的pearson相关系数)、Rank IC(股票评分和下期收益的Spearman相关系数)等。这些指标的计算，你可以参考一下https://arxiv.org/pdf/1908.02646.pdf。在计算累计收益的时候，用单利方式计算。在比较结果的时候，需要这几条收益曲线：根据这个算法构建的投资组合、和中证500指数对冲、和沪深300指数对冲、中证500指数、沪深300指数。这里对冲收益就是拿算法的收益减去指数的收益。